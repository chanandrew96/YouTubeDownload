{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>YouTube Downloader</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    {% tailwind_css %}
  </head>

  <body class="bg-gray-50 font-serif leading-normal tracking-normal">
    <div class="container mx-auto">
      <section class="flex flex-col items-center justify-center h-screen">
        <h1 class="text-4xl mb-8">YouTube Downloader</h1>
        <form id="downloadForm" class="w-full max-w-md">
          {% csrf_token %}
          <div class="flex flex-col gap-4">
            <input
              type="text"
              name="video_url"
              placeholder="输入 YouTube 视频链接"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
              required
            />
            <button
              type="submit"
              class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-200"
            >
              下载视频
            </button>
          </div>
        </form>

        <!-- 进度条容器 -->
        <div id="progressContainer" class="w-full max-w-md mt-4 hidden">
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div
              id="progressBar"
              class="bg-blue-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
          <div id="progressText" class="text-sm text-gray-600 mt-2 text-center">
            准备下载...
          </div>
        </div>

        {% if message %}
        <div
          class="mt-4 p-4 {% if error %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %} rounded-lg"
        >
          {{ message }}
        </div>
        {% endif %}
      </section>
    </div>

    <!-- 添加 JavaScript -->
    <script>
      document
        .getElementById("downloadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);
          const progressContainer =
            document.getElementById("progressContainer");
          const progressBar = document.getElementById("progressBar");
          const progressText = document.getElementById("progressText");

          // 显示进度条
          progressContainer.classList.remove("hidden");
          progressBar.style.width = "0%";
          progressText.textContent = "准备下载...";

          try {
            // 开始下载
            const response = await fetch("/download/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": form.querySelector(
                  '[name="csrfmiddlewaretoken"]'
                ).value,
              },
              body: formData,
            });

            if (response.ok) {
              // 修改获取文件名的逻辑
              const contentDisposition = response.headers.get("Content-Disposition");
              let filename = "download.mp4"; // 默认文件名
              
              if (contentDisposition) {
                const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (matches && matches[1]) {
                  filename = matches[1].replace(/['"]/g, '');
                }
              }

              // 创建 Blob 并下载
              const blob = await response.blob();
              const downloadUrl = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = downloadUrl;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(downloadUrl);
              a.remove();

              progressText.textContent = "下载完成！";
              progressBar.style.width = "100%";
            } else {
              throw new Error("下载失败");
            }
          } catch (error) {
            progressText.textContent = `错误：${error.message}`;
            progressBar.style.backgroundColor = "#ef4444"; // 红色
          }
        });

      // 设置 WebSocket 连接来获取进度更新
      const ws = new WebSocket(`ws://${window.location.host}/ws/progress/`);
      ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");

        progressBar.style.width = `${data.progress}%`;
        progressText.textContent = data.status;
      };
    </script>
  </body>
</html>
